#!/bin/bash

#script for classifying transcripts and filtering fusion transcripts using SQANTI3
#SQANTI3 is run as a singularity image file (.sif) within a Singularity container
#use final merged transcriptome (LRS_SRS_merged_modified.gtf)

use with gtf file generated in step 2 and full-length (full-length_count.txt), isoform (.isoform.results) and splice junction (.twopassSJ.out.tab) quantification obtained in step 3
#in addition, SQANTI3 uses as inputs reference fasta and gtf, cage_peaks (refTSS database) and PolyA_motifs (supplied in the SQANTI3 data folder) files

#load modules
module load apps/singularity/3.7.1

#classification of transcripts from final merged transcriptome
singularity exec -B /../MERGED_TRANSCRIPTOME /projects/globalscratch/sqanti3_3.0.sif sqanti3_qc.py \
/../MERGED_TRANSCRIPTOME/LRS_SRS_merged_modified.gtf /../REFERENCE_INPUT/Mus_musculus.GRCm38.101.gtf /../REFERENCE_INPUT/Mus_musculus.GRCm38.dna.primary_assembly.fa \
--cage_peak /../REFERENCE_INPUT/1refTSS_v3.3_mouse_coordinate.mm10.bed --polyA_motif_list  /../REFERENCE_INPUT/PolyA_motif_List_mm10.txt  \
--gtf -o /../MERGED_TRANSCRIPTOME/LRS_SRS_merged_modified  --isoAnnotLite --gff3 /../REFERENCE_INPUT/Mus_musculus_GRCm38_Ensembl_86.gff3 

#select fusion transcripts from LRS_SRS_merged_modified
R
PCSTRnofusion <- mergedpcstr2filtereddegradationama.nofus_NOCAP_sqanti_classification %>% subset(structural_category != "fusion", select = c("isoform", "structural_category")) %>% rename(structural_category_pcst = structural_category) 

singularity exec -B /../MERGED_TRANSCRIPTOME /projects/globalscratch/sqanti3_3.0.sif sqanti3_qc.py  /../MERGED_TRANSCRIPTOME/LRS_SRS_merged_modified.gtf /../REFERENCE_INPUT/mm10.ncbiRefSeq2.gtf /../REFERENCE_INPUT/Mus_musculus.GRCm38.dna.primary_assembly.fa   --gtf -o mergedpcstr2.nofus_NOCAP_RefSeqsqanti --skipORF --skip_report
singularity exec -B /../MERGED_TRANSCRIPTOME /projects/globalscratch/sqanti3_3.0.sif sqanti3_qc.py  /../MERGED_TRANSCRIPTOME/LRS_SRS_merged_modified.gtf /../REFERENCE_INPUT/gencode.vM10.primary_assembly.annotation.gtf /../REFERENCE_INPUT/Mus_musculus.GRCm38.dna.primary_assembly.fa   --gtf -o mergedpcstr2.nofus_NOCAP_gencodesqanti --skipORF â€”skip_report

